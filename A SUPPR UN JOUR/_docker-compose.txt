version: "3"
services:
  db:
    image: mysql:8.0
    restart: always
    container_name: db_mysql_tiramisu
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
  prisma:
    image: prismagraphql/prisma:1.34
    restart: always
    ports:
      - "4466:4466"
    environment:
      PRISMA_CONFIG: |
        port: 4466
        databases:
          default:
            connector: mysql
            host: ${DB_HOST}
            port: ${DB_PORT}
            user: ${DB_USER}
            password: ${DB_PASSWORD}
            database: ${DB_DATABASE}
        managementApiSecret: ${API_SECRET}
    depends_on:
      - db
  # cr√©er un container phpmyadmin
  dbinit:
    image: phpmyadmin/phpmyadmin
    restart: always
    container_name: db_phpmyadmin_tiramisu
    environment:
      PMA_HOST: db
      PMA_PORT: ${DB_PORT} #3306
      PMA_USER: ${DB_USER}
      PMA_PASSWORD: ${DB_PASSWORD}
    ports:
      - "8080:80"
    depends_on:
      - db
  backend:
    build:
      context: .
    ports:
      - "5001:5001"
    volumes:
      - .:/app
    environment:
      - NODE_ENV=production
      # - DATABASE_URL=mysql://root:Taster_root+123@BOCAL-2023%@db_mysql_tiramisu:3306/tiramisu_base
    # command: npx prisma migrate dev --name init --schema=./schema.prisma
    depends_on:
      - db
      - prisma
      - dbinit
volumes:
  db_data:
